# 🤖 Jarvis AI 知识库系统 - 项目概览

## 📋 项目简介

Jarvis AI 是一个企业级本地化文档智能问答系统，支持PDF/Markdown文档上传，基于向量检索和本地LLM实现智能问答。系统采用模块化架构设计，提供完整的文档处理、向量化存储、智能检索和问答功能。

## 🏗️ 系统架构

### 核心模块
```
jarvis/
├── 🧠 core/                    # 核心业务逻辑
│   ├── knowledge_engine.py     # 知识库引擎 - 统一业务入口
│   ├── document_processor.py   # 文档处理器 - PDF/MD解析
│   ├── vector_manager.py       # 向量管理器 - 嵌入存储
│   └── query_engine.py         # 查询引擎 - 检索优化
├── 🤖 models/                  # AI模型层
│   ├── llm_interface.py        # LLM接口 - 本地模型集成
│   └── embedding_model.py      # 嵌入模型 - 文本向量化
├── 🌐 web/                     # Web界面
│   └── templates/index.html    # 前端界面
├── ⚙️ config/                  # 配置管理
│   └── settings.py             # 系统配置
└── 🛠️ utils/                   # 工具库
    └── text_utils.py           # 文本处理工具
```

### 数据流程
1. **文档上传** → 文档处理器解析内容
2. **文本分块** → 智能切分长文档
3. **向量化** → 生成文本嵌入向量
4. **存储** → ChromaDB向量数据库
5. **查询** → 语义检索 + 关键词匹配
6. **生成** → LLM基于检索结果生成回答

## 🔍 代码审查发现的问题

### 🚨 高危问题 (需立即修复)
1. **路径遍历漏洞** - 用户输入未验证直接用于文件路径构建
2. **SQL注入风险** - 查询参数未经过滤
3. **XSS漏洞** - 用户输入未转义直接输出
4. **硬编码凭据** - Flask密钥和配置硬编码
5. **日志注入** - 用户输入直接写入日志

### ⚠️ 中危问题 (建议修复)
1. **不安全哈希** - 使用MD5算法
2. **性能问题** - 字符串循环拼接
3. **错误处理不当** - 异常捕获过于宽泛
4. **包漏洞** - 依赖包存在已知安全漏洞

### 💡 优化建议
1. **导入优化** - 使用具体导入替代通配符导入
2. **代码可读性** - 提取硬编码常量
3. **文档完善** - 添加函数文档说明

## 🎯 检索精度优化方案

### 当前问题
- 简单向量相似度匹配容易返回不相关文档
- 缺乏关键词匹配和语义理解
- 没有相关性阈值过滤

### 优化策略

#### 1. 多层检索架构
```python
查询预处理 → 向量检索 → 关键词增强 → 相关性过滤 → 重排序
```

#### 2. 关键词匹配增强
- 提取查询关键词
- 计算关键词匹配度
- 结合向量相似度综合评分

#### 3. 相关性阈值过滤
- 设置最低相关性阈值 (0.3)
- 过滤低质量匹配结果
- 动态调整阈值

#### 4. 智能重排序
- 综合向量相似度和关键词匹配
- 考虑文档类型和来源权重
- 用户反馈学习优化

## 📊 技术栈详情

### 后端技术
- **Web框架**: Flask + SocketIO (实时通信)
- **向量数据库**: ChromaDB (本地向量存储)
- **文档处理**: PyPDF2 + Markdown (多格式支持)
- **嵌入模型**: 简化哈希向量化 (避免外部依赖)
- **本地LLM**: Ollama集成 (可选)

### 前端技术
- **界面**: HTML5 + JavaScript + CSS3
- **实时通信**: Socket.IO客户端
- **文件上传**: 拖拽上传支持

### 存储架构
- **文档存储**: `/Volumes/common/jarvis/documents/`
- **向量数据库**: `/Volumes/common/jarvis/vector_db/`
- **临时文件**: `/Volumes/common/jarvis/uploads/`

## 🔧 部署配置

### 环境要求
- Python 3.8+
- 4GB+ 内存
- 10GB+ 存储空间

### 核心配置
```python
# 服务器配置
HOST = "0.0.0.0"
PORT = 8080

# 模型配置
LLM_URL = "http://localhost:11434"  # Ollama服务
EMBEDDING_DIM = 384                 # 向量维度

# 检索配置
RELEVANCE_THRESHOLD = 0.3           # 相关性阈值
MAX_RESULTS = 5                     # 最大返回结果
```

## 🚀 性能优化建议

### 1. 向量化优化
- 使用更高效的嵌入模型
- 批量处理文档向量化
- 向量维度优化 (384 → 768)

### 2. 检索优化
- 实现向量索引加速
- 缓存热门查询结果
- 异步处理长文档

### 3. 存储优化
- 数据库连接池
- 向量压缩存储
- 定期清理临时文件

## 🛡️ 安全加固方案

### 1. 输入验证
```python
from werkzeug.utils import secure_filename
filename = secure_filename(file.filename)
```

### 2. 路径安全
```python
from pathlib import Path
safe_path = Path(base_dir) / secure_filename(filename)
```

### 3. 配置安全
```python
import os
SECRET_KEY = os.environ.get('FLASK_SECRET_KEY', 'default-key')
```

## 📈 监控指标

### 系统指标
- 文档处理速度 (文档/分钟)
- 查询响应时间 (毫秒)
- 向量数据库大小 (MB)
- 内存使用率 (%)

### 业务指标
- 查询准确率 (%)
- 用户满意度评分
- 文档覆盖率 (%)
- 系统可用性 (%)

## 🔮 未来规划

### 短期目标 (1-2个月)
- [ ] 修复所有高危安全问题
- [ ] 实现增强检索引擎
- [ ] 添加用户反馈机制
- [ ] 完善错误处理

### 中期目标 (3-6个月)
- [ ] 支持更多文档格式 (Word, Excel)
- [ ] 实现多语言支持
- [ ] 添加用户权限管理
- [ ] 集成更多LLM模型

### 长期目标 (6-12个月)
- [ ] 分布式部署支持
- [ ] 企业级权限控制
- [ ] API接口开放
- [ ] 移动端应用

## 📞 技术支持

### 问题排查
1. 查看日志文件: `jarvis.log`
2. 检查服务状态: `http://localhost:8080/stats`
3. 验证配置: `config/settings.py`

### 常见问题
- **端口占用**: 修改配置中的PORT设置
- **权限问题**: 检查存储目录权限
- **模型加载失败**: 确认Ollama服务状态

---

**项目状态**: 🟡 开发中 (存在安全问题需修复)  
**最后更新**: 2025-08-13  
**版本**: v1.0.0-beta